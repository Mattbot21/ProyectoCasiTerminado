{% extends 'base.html' %}
{% load static %}

{% block title %}{{ libro.titulo }} - Librería Digital{% endblock %}

{% block content %}
<section class="book-detail-section">
    <div class="container">
        <div class="book-detail-card" data-aos="fade-up">
            <div class="row g-0">
                <div class="col-lg-4">
                    <div class="book-detail-image p-4">
                        {% if libro.portada %}
                        <img src="{{ libro.portada.url }}" alt="{{ libro.titulo }}">
                        {% else %}
                        <img src="/placeholder.svg?height=500&width=350" alt="{{ libro.titulo }}">
                        {% endif %}
                        <span class="book-detail-badge">{{ libro.genero|title }}</span>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="book-detail-content">
                        <h1 class="book-detail-title">{{ libro.titulo }}</h1>
                        
                        <div class="book-detail-meta">
                            <div class="meta-item">
                                <i class="bi bi-person"></i>
                                <span>{{ libro.autor }}</span>
                            </div>
                            <div class="meta-item">
                                <i class="bi bi-bookmark"></i>
                                <span>{{ libro.genero|title }}</span>
                            </div>
                            {% if libro.fecha_publicacion %}
                            <div class="meta-item">
                                <i class="bi bi-calendar"></i>
                                <span>{{ libro.fecha_publicacion }}</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <p class="book-description">
                            {{ libro.descripcion|default:"Este libro aún no tiene una descripción disponible. ¡Pero estamos seguros de que te encantará explorarlo!" }}
                        </p>
                        
                        {% if user.is_authenticated %}
                        <div class="book-actions">
                            {% if es_favorito %}
                            <span class="btn btn-favorite is-favorite">
                                <i class="bi bi-heart-fill"></i> Ya en favoritos
                            </span>
                            {% else %}
                            <a href="{% url 'agregar_favorito' libro.id %}" class="btn btn-favorite">
                                <i class="bi bi-heart"></i> Agregar a favoritos
                            </a>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="reviews-section">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <h2 class="section-title mb-4" data-aos="fade-up">
                    <i class="bi bi-chat-quote text-accent me-2"></i>Reseñas
                </h2>
                
                {% if reseñas %}
                {% for reseña in reseñas %}
                <div class="review-card" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:50 }}">
                    <div class="review-header">
                        <div class="reviewer-info">
                            <div class="reviewer-avatar">
                                {{ reseña.usuario.username|slice:":1"|upper }}
                            </div>
                            <div>
                                <h5 class="reviewer-name">{{ reseña.usuario.username }}</h5>
                                <span class="review-date">{{ reseña.fecha|date:"d/m/Y H:i" }}</span>
                            </div>
                        </div>
                        <div class="review-rating">
                            {% for i in "12345" %}
                                {% if forloop.counter <= reseña.calificacion %}
                                <i class="bi bi-star-fill"></i>
                                {% else %}
                                <i class="bi bi-star" style="color: var(--gray-600);"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    <p class="review-content">{{ reseña.comentario }}</p>
                    
                    <!-- Valoración de la reseña (H9) -->
                    <div class="review-rating-stats mb-3 p-3 bg-light rounded">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-star-fill text-warning" style="font-size: 1.5rem;"></i>
                                    <div>
                                        <strong style="font-size: 1.3rem;">{{ reseña.promedio_valoracion|floatformat:1 }}</strong>
                                        <small class="text-muted ms-1">({{ reseña.total_valoraciones }} valoraciones)</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 text-md-end mt-2 mt-md-0">
                                {% if user.is_authenticated and user != reseña.usuario %}
                                <a href="{% url 'valorar_reseña' reseña.id %}" class="btn btn-sm btn-outline-warning">
                                    <i class="bi bi-star"></i> Valorar reseña
                                </a>
                                {% elif user == reseña.usuario %}
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> Es tu reseña
                                </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comentarios de la reseña (H6, H7, H8) -->
                    <div class="comments-section mt-3">
                        <div class="comments-header d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">
                                <i class="bi bi-chat-text"></i> 
                                Comentarios ({{ reseña.comentarios.count }})
                            </h6>
                            {% if user.is_authenticated %}
                            <a href="{% url 'crear_comentario' reseña.id %}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-plus-circle"></i> Comentar
                            </a>
                            {% endif %}
                        </div>
                        
                        {% if reseña.comentarios.all %}
                        <div class="comments-list" style="max-height: 400px; overflow-y: auto;">
                            {% for comentario in reseña.comentarios.all %}
                                {% if not comentario.padre %}
                                <!-- Comentario principal -->
                                <div class="comment-item p-3 mb-2 border rounded bg-light">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <strong>{{ comentario.usuario.username }}</strong>
                                            <small class="text-muted ms-2">{{ comentario.fecha|date:"d/m/Y H:i" }}</small>
                                        </div>
                                        <div class="btn-group btn-group-sm">
                                            {% if user == comentario.usuario %}
                                                <a href="{% url 'editar_comentario' comentario.id %}" 
                                                   class="btn btn-sm btn-outline-warning" 
                                                   title="Editar">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                <a href="{% url 'eliminar_comentario' comentario.id %}" 
                                                   class="btn btn-sm btn-outline-danger" 
                                                   title="Eliminar">
                                                    <i class="bi bi-trash"></i>
                                                </a>
                                            {% endif %}
                                            {% if user.is_authenticated %}
                                                <a href="{% url 'responder_comentario' comentario.id %}" 
                                                   class="btn btn-sm btn-outline-primary" 
                                                   title="Responder">
                                                    <i class="bi bi-reply"></i>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <p class="mb-0">{{ comentario.contenido }}</p>
                                    
                                    <!-- Respuestas anidadas (H16) -->
                                    {% if comentario.respuestas.exists %}
                                        <div class="ms-4 mt-2">
                                            {% for respuesta in comentario.respuestas.all %}
                                                <div class="comment-item p-2 mb-2 border-start border-primary border-3 bg-white">
                                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                                        <div>
                                                            <strong class="small">{{ respuesta.usuario.username }}</strong>
                                                            <small class="text-muted ms-1" style="font-size: 0.75rem;">{{ respuesta.fecha|date:"d/m/Y H:i" }}</small>
                                                        </div>
                                                        {% if user == respuesta.usuario %}
                                                        <div class="btn-group btn-group-sm">
                                                            <a href="{% url 'editar_comentario' respuesta.id %}" 
                                                               class="btn btn-sm btn-outline-warning" 
                                                               style="font-size: 0.7rem; padding: 0.15rem 0.3rem;"
                                                               title="Editar">
                                                                <i class="bi bi-pencil"></i>
                                                            </a>
                                                            <a href="{% url 'eliminar_comentario' respuesta.id %}" 
                                                               class="btn btn-sm btn-outline-danger" 
                                                               style="font-size: 0.7rem; padding: 0.15rem 0.3rem;"
                                                               title="Eliminar">
                                                                <i class="bi bi-trash"></i>
                                                            </a>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    <p class="mb-0 small">{{ respuesta.contenido }}</p>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted small mb-0">
                            <i class="bi bi-info-circle"></i> No hay comentarios aún. ¡Sé el primero!
                        </p>
                        {% endif %}
                    </div>
                    
                    <div class="review-actions">
                        {% if user.is_authenticated %}
                        <a href="{% url 'reportar_reseña' reseña.id %}" class="btn-review-action">
                            <i class="bi bi-flag me-1"></i>Reportar
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="empty-state" data-aos="fade-up">
                    <i class="bi bi-chat-dots empty-state-icon"></i>
                    <h4>Sin reseñas todavía</h4>
                    <p>¡Sé el primero en compartir tu opinión!</p>
                </div>
                {% endif %}
            </div>
            
            <div class="col-lg-4">
                {% if user.is_authenticated and user.is_usuario %}
                <div class="review-form-card" data-aos="fade-up">
                    <h3 class="review-form-title">
                        <i class="bi bi-pencil-square text-accent"></i>
                        Escribir reseña
                    </h3>
                    <form method="POST" action="{% url 'crear_reseña' libro.id %}" id="reseñaForm">
                        {% csrf_token %}
                        <div class="form-group">
                            <label class="form-label">Tu comentario</label>
                            <textarea name="comentario" class="form-control form-control-custom" rows="4" placeholder="Comparte tu opinión sobre este libro..." required></textarea>
                        </div>
                        
                        <!-- H13: Selector de estrellas mejorado -->
                        <div class="form-group">
                            <label class="form-label">Calificación</label>
                            <div class="star-rating-input" id="starRatingInput">
                                <input type="radio" name="calificacion" value="5" id="rating5" checked>
                                <label for="rating5" title="5 estrellas - Excelente">⭐</label>
                                
                                <input type="radio" name="calificacion" value="4" id="rating4">
                                <label for="rating4" title="4 estrellas - Bueno">⭐</label>
                                
                                <input type="radio" name="calificacion" value="3" id="rating3">
                                <label for="rating3" title="3 estrellas - Regular">⭐</label>
                                
                                <input type="radio" name="calificacion" value="2" id="rating2">
                                <label for="rating2" title="2 estrellas - Malo">⭐</label>
                                
                                <input type="radio" name="calificacion" value="1" id="rating1">
                                <label for="rating1" title="1 estrella - Muy malo">⭐</label>
                            </div>
                            <div id="ratingDescription" class="text-muted small mt-2">
                                5 estrellas - Excelente
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-submit w-100">
                            <i class="bi bi-send"></i>
                            Publicar reseña
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<style>
    /* H13: Estilos para calificación con estrellas */
    .star-rating-input {
        display: flex;
        flex-direction: row-reverse;
        justify-content: flex-end;
        gap: 5px;
        font-size: 2rem;
    }

    .star-rating-input input[type="radio"] {
        display: none;
    }

    .star-rating-input label {
        cursor: pointer;
        transition: all 0.2s ease;
        filter: grayscale(100%);
        opacity: 0.5;
    }

    .star-rating-input label:hover,
    .star-rating-input label:hover ~ label {
        filter: grayscale(0%);
        opacity: 1;
        transform: scale(1.1);
    }

    .star-rating-input input[type="radio"]:checked ~ label {
        filter: grayscale(0%);
        opacity: 1;
    }

    .star-rating-input input[type="radio"]:checked + label {
        filter: grayscale(0%);
        opacity: 1;
    }

    #ratingDescription {
        font-weight: 500;
        min-height: 20px;
    }
</style>

<script>
    // H13: JavaScript para selector de estrellas interactivo
    document.addEventListener('DOMContentLoaded', function() {
        const ratingInputs = document.querySelectorAll('input[name="calificacion"]');
        const ratingDescription = document.getElementById('ratingDescription');
        
        const descriptions = {
            '1': '1 estrella - Muy malo',
            '2': '2 estrellas - Malo',
            '3': '3 estrellas - Regular',
            '4': '4 estrellas - Bueno',
            '5': '5 estrellas - Excelente'
        };
        
        // Actualizar descripción al cambiar selección
        ratingInputs.forEach(input => {
            input.addEventListener('change', function() {
                ratingDescription.textContent = descriptions[this.value];
                ratingDescription.style.color = this.value >= 4 ? '#28a745' : (this.value == 3 ? '#ffc107' : '#dc3545');
            });
        });
        
        // Actualizar descripción al hacer hover
        const labels = document.querySelectorAll('.star-rating-input label');
        labels.forEach(label => {
            label.addEventListener('mouseenter', function() {
                const value = this.getAttribute('for').replace('rating', '');
                ratingDescription.textContent = descriptions[value];
                ratingDescription.style.color = '#6c757d';
            });
        });
        
        // Restaurar descripción al salir del hover
        document.getElementById('starRatingInput').addEventListener('mouseleave', function() {
            const checked = document.querySelector('input[name="calificacion"]:checked');
            if (checked) {
                const value = checked.value;
                ratingDescription.textContent = descriptions[value];
                ratingDescription.style.color = value >= 4 ? '#28a745' : (value == 3 ? '#ffc107' : '#dc3545');
            }
        });
    });
</script>
{% endblock %}
